name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0
  workflow_dispatch:  # Allows manual trigger

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build Electron app
        run: npm run build:win
      
      - name: Get version from package.json
        id: package-version
        run: |
          $version = (Get-Content package.json | ConvertFrom-Json).version
          echo "version=$version" >> $env:GITHUB_OUTPUT
        shell: pwsh
      
      - name: Generate Changelog
        id: changelog
        run: |
          $currentTag = "${{ github.ref_name }}"
          
          # Get the previous tag
          $previousTag = git describe --tags --abbrev=0 "$currentTag^" 2>$null
          
          if ($previousTag) {
            Write-Host "Generating changelog from $previousTag to $currentTag"
            
            # Get commits between tags, grouped by type
            $commits = git log "$previousTag..$currentTag" --pretty=format:"%s|%h" --no-merges
            
            $features = @()
            $fixes = @()
            $changes = @()
            $other = @()
            
            foreach ($commit in $commits) {
              if ($commit) {
                $parts = $commit -split '\|'
                $message = $parts[0]
                $hash = $parts[1]
                
                $line = "- $message ([$hash](https://github.com/${{ github.repository }}/commit/$hash))"
                
                if ($message -match '^feat(\(.*?\))?:|^feature:') {
                  $features += $line
                } elseif ($message -match '^fix(\(.*?\))?:|^bugfix:') {
                  $fixes += $line
                } elseif ($message -match '^chore(\(.*?\))?:|^docs(\(.*?\))?:|^style(\(.*?\))?:|^refactor(\(.*?\))?:') {
                  $changes += $line
                } else {
                  $other += $line
                }
              }
            }
            
            # Build changelog sections
            $changelog = ""
            
            if ($features.Count -gt 0) {
              $changelog += "### âœ¨ New Features`n`n"
              $changelog += ($features -join "`n") + "`n`n"
            }
            
            if ($fixes.Count -gt 0) {
              $changelog += "### ğŸ› Bug Fixes`n`n"
              $changelog += ($fixes -join "`n") + "`n`n"
            }
            
            if ($changes.Count -gt 0) {
              $changelog += "### ğŸ”§ Maintenance & Improvements`n`n"
              $changelog += ($changes -join "`n") + "`n`n"
            }
            
            if ($other.Count -gt 0) {
              $changelog += "### ğŸ“ Other Changes`n`n"
              $changelog += ($other -join "`n") + "`n`n"
            }
            
            if ($changelog -eq "") {
              $changelog = "### ğŸ“ Changes`n`nFirst release or no categorized changes.`n`n"
            }
          } else {
            Write-Host "No previous tag found - this is the first release"
            $changelog = "### ğŸ‰ Initial Release`n`nFirst official release of Google Drive Downloader!`n`n"
          }
          
          # Escape for GitHub Actions (replace newlines with %0A)
          $changelog = $changelog -replace "`r`n", "%0A" -replace "`n", "%0A"
          echo "content=$changelog" >> $env:GITHUB_OUTPUT
        shell: pwsh
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/Google Drive Downloader ${{ steps.package-version.outputs.version }}.exe
          tag_name: ${{ github.event_name == 'workflow_dispatch' && format('v{0}', steps.package-version.outputs.version) || github.ref_name }}
          draft: ${{ github.event_name == 'workflow_dispatch' }}
          prerelease: false
          body: |
            ## ğŸ“¦ Google Drive Downloader v${{ steps.package-version.outputs.version }}
            
            A desktop application to automatically download files from **public** Google Drive folders with scheduling capabilities.
            
            ### â¬‡ï¸ Installation
            
            1. Download **`Google Drive Downloader ${{ steps.package-version.outputs.version }}.exe`** below
            2. Run the executable - **no installation required!**
            3. If Windows shows a security warning, click **"More info"** â†’ **"Run anyway"**
            
            ### âœ¨ Features
            
            - ğŸ“ Download from public Google Drive folders (no authentication needed)
            - ğŸ–¥ï¸ Desktop application with user-friendly interface
            - â° Automatic scheduling with cron expressions
            - ğŸ“¦ Optional automatic ZIP extraction
            - ğŸ”„ Download all files or just the latest version
            - ğŸ“Š Real-time progress tracking
            - ğŸ“‹ Live activity logs
            - ğŸ’¾ Persistent configuration
            
            ---
            
            ## ğŸ“ Changelog
            
            ${{ steps.changelog.outputs.content }}
            
            ---
            
            ### ğŸ› Bug Reports & Feature Requests
            
            Found an issue or have a suggestion? [Open an issue](https://github.com/robinsone/GoogleDownloader/issues/new)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload artifact for manual testing
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: google-drive-downloader-unsigned
          path: dist/Google Drive Downloader ${{ steps.package-version.outputs.version }}.exe
